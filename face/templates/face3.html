<!DOCTYPE html>
<html>
<head>
  <title>ç®¡ç†å¾Œå°</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 800px; margin: auto; }
    h2, h3 { margin-bottom: 10px; }
    input, button, select, textarea { font-size: 14px; margin: 5px 0; padding: 6px; width: 100%; }
    #faceList img { width: 50px; height: 50px; margin-right: 10px; border-radius: 5px; vertical-align: middle; }
    #faceList div { margin-bottom: 8px; }
    #scheduleList { margin-top: 20px; }
    #message, #registerMsg { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>äººè‡‰ç®¡ç†èˆ‡æœƒè­°æ’ç¨‹</h2>

  <section>
    <h3>æ–°å¢ä½¿ç”¨è€…</h3>
    <label for="newName">å§“å</label>
    <input type="text" id="newName" placeholder="è«‹è¼¸å…¥å§“å" />

    <label for="newPhoto">ä¸Šå‚³äººè‡‰ç…§ç‰‡</label>
    <input type="file" id="newPhoto" accept="image/*" />

    <button id="registerBtn">è¨»å†Šä½¿ç”¨è€…</button>
    <div id="registerMsg"></div>
  </section>

  <section>
    <h3>å·²è¨»å†Šäººè‡‰</h3>
    <div id="faceList">è¼‰å…¥ä¸­...</div>
  </section>



  <section>
    <h3>è¨­å®šæ’ç¨‹</h3>
    <label for="meetingName">æœƒè­°åç¨±</label>
    <input type="text" id="meetingName" placeholder="è«‹è¼¸å…¥æœƒè­°åç¨±" />

    <label for="date">æœƒè­°æ—¥æœŸ</label>
    <input type="date" id="date" />

    <label for="startTime">é–‹å§‹æ™‚é–“</label>
    <input type="time" id="startTime" />

    <label for="endTime">çµæŸæ™‚é–“</label>
    <input type="time" id="endTime" />

    <label>é¸æ“‡åƒèˆ‡è€…</label>
    <div id="participantsCheckboxes">è¼‰å…¥ä¸­...</div>

    <button id="saveScheduleBtn">å„²å­˜æ’ç¨‹</button>
    <div id="message"></div>
  </section>

  <section id="scheduleList">
    <h3>ç¾æœ‰æœƒè­°æ’ç¨‹</h3>
    <div id="schedules">è¼‰å…¥ä¸­...</div>
  </section>

<script>
let ip = "https://f3f0dd590a09.ngrok-free.app/api";

async function loadFaces() {
  const res = await fetch(`${ip}/faces`);
  const data = await res.json();
  if (data.status === 'success') {
    const container = document.getElementById('faceList');
    const checkboxContainer = document.getElementById('participantsCheckboxes');
    container.innerHTML = '';
    checkboxContainer.innerHTML = '';

    data.faces.forEach(f => {
      const faceDiv = document.createElement('div');
      faceDiv.innerHTML = `
        <img src="${f.url}" alt="${f.name}">
        ${f.name}
        <button onclick="deleteUser(${f.id})" style="margin-left:10px;color:red;">âŒ åˆªé™¤</button>
      `;
      container.appendChild(faceDiv);

      const checkboxDiv = document.createElement('div');
      checkboxDiv.innerHTML = `
        <label>
          <input type="checkbox" name="participants" value="${f.name}">
          ${f.name}
        </label>
      `;
      checkboxContainer.appendChild(checkboxDiv);
    });
  }
}

async function loadSchedules() {
  const res = await fetch(`${ip}/get_schedules`);
  const data = await res.json();
  if (data.status === 'success') {
    const container = document.getElementById('schedules');
    container.innerHTML = '';
    for (const [time, users] of Object.entries(data.schedule)) {
  const safeTime = encodeURIComponent(time);
  const div = document.createElement('div');
  div.style.marginBottom = "10px";
  div.innerHTML = `
    ${time} ï¼š ${users.join(', ')}
    <button onclick="deleteSchedule(decodeURIComponent('${safeTime}'))" style="margin-left: 10px; color: red;">ğŸ—‘ï¸ åˆªé™¤æ’ç¨‹</button>
  `;
  container.appendChild(div);
}
}}

async function deleteUser(userId) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä½¿ç”¨è€…å—ï¼Ÿé€™æœƒæ¸…é™¤ç…§ç‰‡èˆ‡è³‡æ–™ã€‚')) return;

  const res = await fetch(`${ip}/delete_user/${userId}`, {
    method: 'DELETE'
  });

  const data = await res.json();
  alert(data.message);
  loadFaces();
  loadSchedules();
}

async function deleteSchedule(fullTimeKey) {
  if (!confirm(`ä½ ç¢ºå®šè¦åˆªé™¤æ’ç¨‹ï¼š${fullTimeKey} å—ï¼Ÿ`)) return;

  const [meetingName, timeSlot] = fullTimeKey.split("ï½œ"); 

  const res = await fetch(`${ip}/delete_schedule`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      meeting_name: meetingName.trim(),
      time_slot: timeSlot.trim()
    })
  });

  const data = await res.json();
  alert(data.message);
  loadSchedules();  // é‡æ–°è¼‰å…¥æ’ç¨‹
}


document.getElementById('registerBtn').onclick = async () => {
  const name = document.getElementById('newName').value.trim();
  const photo = document.getElementById('newPhoto').files[0];
  const msgDiv = document.getElementById('registerMsg');

  if (!name || !photo) {
    alert('è«‹å¡«å¯«å§“åä¸¦é¸æ“‡ç…§ç‰‡');
    return;
  }

  const formData = new FormData();
  formData.append("name", name);
  formData.append("photo", photo);

  const res = await fetch(`${ip}/register`, {
    method: 'POST',
    body: formData
  });

  const data = await res.json();
  if (data.status === 'success') {
    msgDiv.style.color = 'green';
    msgDiv.textContent = data.message;
    document.getElementById('newName').value = '';
    document.getElementById('newPhoto').value = '';
    loadFaces();
  } else {
    msgDiv.style.color = 'red';
    msgDiv.textContent = data.message;
  }
};

document.getElementById('saveScheduleBtn').onclick = async () => {
  const meetingName = document.getElementById('meetingName').value.trim();
  const date = document.getElementById('date').value;
  const start = document.getElementById('startTime').value;
  const end = document.getElementById('endTime').value;

  const checkboxes = document.querySelectorAll('input[name="participants"]:checked');
  const names = Array.from(checkboxes).map(cb => cb.value);

  if (!meetingName|| !date || !start || !end || names.length === 0) {
    alert('è«‹å®Œæ•´å¡«å¯«æœƒè­°åç¨±ã€æ—¥æœŸã€æ™‚é–“èˆ‡åƒèˆ‡è€…');
    return;
  }

  if (start >= end) {
    alert('çµæŸæ™‚é–“ä¸èƒ½æ—©æ–¼æˆ–ç­‰æ–¼é–‹å§‹æ™‚é–“');
    return;
  }
// {"meetingName": meetingName, "names":names, "time_slot": timeSlot}
  const timeSlot = `${date} ${start}-${end}`;
  const payload = {};
  payload["time_slot"] = timeSlot;
  payload["meeting_name"] = meetingName
  payload["names"] = names;

  const res = await fetch(`${ip}/allowed_users_by_schedule`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  const msgDiv = document.getElementById('message');
  if (data.status === 'success') {
    msgDiv.style.color = 'green';
    msgDiv.textContent = data.message;
    loadSchedules();
  } else {
    msgDiv.style.color = 'red';
    msgDiv.textContent = data.message;
  }
};

window.onload = () => {
  loadFaces();
  loadSchedules();
};
</script>
</body>
</html>