<!DOCTYPE html>
<html>
<head>
  <title>管理後台</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 800px; margin: auto; }
    h2, h3 { margin-bottom: 10px; }
    input, button, select, textarea { font-size: 14px; margin: 5px 0; padding: 6px; width: 100%; }
    #faceList img { width: 50px; height: 50px; margin-right: 10px; border-radius: 5px; vertical-align: middle; }
    #faceList div { margin-bottom: 8px; }
    #scheduleList { margin-top: 20px; }
    #message, #registerMsg { margin-top: 10px; font-weight: bold; }
  </style>
 <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div id="cameraModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; text-align:center;">
    <h3>請對準鏡頭並點擊下方按鈕</h3>
    <video id="cameraVideo" autoplay width="320" height="240" style="border:1px solid #ccc;"></video><br>
    <button id="takePhotoBtn" style="margin-top:10px;">拍照註冊</button>
    <button onclick="closeCameraModal()" style="margin-top:10px;">取消</button>
  </div>
</div>

  <h2>人臉管理與會議排程</h2>

  <section>
    <h3>新增使用者</h3>
    <label for="newName">姓名</label>
    <input type="text" id="newName" placeholder="請輸入姓名" />

    <label for="newPhoto">上傳人臉照片</label>
    <input type="file" id="newPhoto" accept="image/*" />

    <button id="registerBtn">註冊使用者</button>
    <div id="registerMsg"></div>
  </section>

  <section>
    <h3>已註冊人臉</h3>
    <div id="faceList">載入中...</div>
  </section>

  <section>
    <h3>設定排程</h3>
    <label for="meetingName">會議名稱</label>
    <input type="text" id="meetingName" placeholder="請輸入會議名稱" />

    <label for="date">會議日期</label>
    <input type="date" id="date" />

    <label for="startTime">開始時間</label>
    <input type="time" id="startTime" />

    <label for="endTime">結束時間</label>
    <input type="time" id="endTime" />

    <label>選擇參與者</label>
    <div id="participantsCheckboxes">載入中...</div>

    <button id="saveScheduleBtn">儲存排程</button>
    <div id="message"></div>
  </section>

  <section id="scheduleList">
    <h3>現有會議排程</h3>
    <div id="schedules">載入中...</div>
  </section>
  <button id="logoutBtn">登出</button>

<script>
let ip = "https://b8a1bfc61afd.ngrok-free.app";

async function loadFaces() {
  const res = await fetch(`${ip}/api/faces`, { credentials: 'include' });
  const data = await res.json();
  if (data.status === 'success') {
    const container = document.getElementById('faceList');
    const checkboxContainer = document.getElementById('participantsCheckboxes');
    container.innerHTML = '';
    checkboxContainer.innerHTML = '';

    data.faces.forEach(f => {
      const faceDiv = document.createElement('div');
    
      const img = document.createElement('img');
      img.src = f.url;
      img.alt = f.name;
      
      const nameText = document.createTextNode(f.name);

      const delBtn = document.createElement('button');
      delBtn.textContent = "刪除";
      delBtn.style.color = "red";
      delBtn.style.marginLeft = "10px";
      delBtn.onclick = () => deleteUser(f.id);

      faceDiv.appendChild(img);
      faceDiv.appendChild(nameText);
      faceDiv.appendChild(delBtn);
      container.appendChild(faceDiv);

      const checkboxDiv = document.createElement('div');
      checkboxDiv.innerHTML = `
        <label>
          <input type="checkbox" name="participants" value="${f.name}">
          ${f.name}
        </label>
      `;
      checkboxContainer.appendChild(checkboxDiv);
    });
  }
}

async function loadSchedules() {
  const res = await fetch(`${ip}/api/get_schedules`, { credentials: 'include' });
  const data = await res.json();
  if (data.status === 'success') {
    const container = document.getElementById('schedules');
    container.innerHTML = '';
    for (const [time, users] of Object.entries(data.schedule)) {
      const safeTime = encodeURIComponent(time);
      const div = document.createElement('div');
      div.style.marginBottom = "10px";
      div.innerHTML = `
        ${time} ： ${users.join(', ')}
        <button onclick="deleteSchedule(decodeURIComponent('${safeTime}'))" style="margin-top: 10px; color: red;">刪除排程</button>
      `;
      container.appendChild(div);
    }
  }
}

async function deleteUser(userId) {
  if (!confirm('確定要刪除這個使用者嗎？這會清除照片與資料。')) return;

  const res = await fetch(`${ip}/api/delete_user/${userId}`, {
    method: 'DELETE',
    credentials: 'include'
  });

  const data = await res.json();
  alert(data.message);
  loadFaces();
  loadSchedules();
}

async function deleteSchedule(fullTimeKey) {
  if (!confirm(`你確定要刪除排程：${fullTimeKey} 嗎？`)) return;

  const [meetingName, timeSlot] = fullTimeKey.split("｜"); 

  const res = await fetch(`${ip}/api/delete_schedule`, {
    method: "POST",
    credentials: 'include',
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      meeting_name: meetingName.trim(),
      time_slot: timeSlot.trim()
    })
  });

  const data = await res.json();
  alert(data.message);
  loadSchedules();
}

document.getElementById('registerBtn').onclick = async () => {
  const name = document.getElementById('newName').value.trim();
  const photoInput = document.getElementById('newPhoto');
  const photo = photoInput.files[0];
  const msgDiv = document.getElementById('registerMsg');

  if (!name) {
    alert('請輸入姓名');
    return;
  }

  const checkRes = await fetch(`${ip}/api/check_name_exists?name=${encodeURIComponent(name)}`, {
    credentials: 'include'
  });
  const checkData = await checkRes.json();

  if (checkData.exists) {
    alert('此姓名已註冊，請使用不同名稱');
    return;
  }

  if (photo) {
    // ✅ 有照片就直接註冊
    const formData = new FormData();
    formData.append("name", name);
    formData.append("photo", photo);

    const res = await fetch(`${ip}/api/register`, {
      method: 'POST',
      credentials: 'include',
      body: formData
    });

    const data = await res.json();
    if (data.status === 'success') {
      msgDiv.style.color = 'green';
      msgDiv.textContent = data.message;
      document.getElementById('newName').value = '';
      photoInput.value = '';
      loadFaces();
    } else {
      msgDiv.style.color = 'red';
      msgDiv.textContent = data.message;
    }
  } else {
    // ❌ 沒有照片 → 自動開啟相機拍照
    try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const video = document.getElementById('cameraVideo');
    video.srcObject = stream;
    videoStream = stream; // 儲存 stream，等下拍照後可以關掉
    document.getElementById('cameraModal').style.display = 'flex';
  } catch (err) {
    alert('開啟攝影機失敗，請允許瀏覽器使用相機');
    console.error(err);
  }
}
};

document.getElementById('saveScheduleBtn').onclick = async () => {
  const meetingName = document.getElementById('meetingName').value.trim();
  const date = document.getElementById('date').value;
  const start = document.getElementById('startTime').value;
  const end = document.getElementById('endTime').value;

  const checkboxes = document.querySelectorAll('input[name="participants"]:checked');
  const names = Array.from(checkboxes).map(cb => cb.value);

  if (!meetingName || !date || !start || !end || names.length === 0) {
    alert('請完整填寫會議名稱、日期、時間與參與者');
    return;
  }

  if (start >= end) {
    alert('結束時間不能早於或等於開始時間');
    return;
  }

  const timeSlot = `${date} ${start}-${end}`;
  const payload = {
    time_slot: timeSlot,
    meeting_name: meetingName,
    names: names
  };

  const res = await fetch(`${ip}/api/allowed_users_by_schedule`, {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  const msgDiv = document.getElementById('message');
  if (data.status === 'success') {
    msgDiv.style.color = 'green';
    msgDiv.textContent = data.message;
    loadSchedules();
  } else {
    msgDiv.style.color = 'red';
    msgDiv.textContent = data.message;
  }
};

let videoStream = null;

function closeCameraModal() {
  document.getElementById('cameraModal').style.display = 'none';
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
}

document.getElementById('takePhotoBtn').onclick = async () => {
  const name = document.getElementById('newName').value.trim();
  const msgDiv = document.getElementById('registerMsg');
  const video = document.getElementById('cameraVideo');

  if (!name) {
    alert("請輸入姓名後再拍照");
    return;
  }

  const canvas = document.createElement('canvas');
  canvas.width = 320;
  canvas.height = 240;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  canvas.toBlob(async blob => {
    const formData = new FormData();
    formData.append("name", name);
    formData.append("photo", blob, `${name}.jpg`);

    const res = await fetch(`${ip}/api/register`, {
      method: 'POST',
      credentials: 'include',
      body: formData
    });

    const data = await res.json();
    if (data.status === 'success') {
      msgDiv.style.color = 'green';
      msgDiv.textContent = data.message;
      document.getElementById('newName').value = '';
      loadFaces();
    } else {
      msgDiv.style.color = 'red';
      msgDiv.textContent = data.message;
    }

    closeCameraModal();
  }, 'image/jpeg');
};

document.getElementById('logoutBtn').onclick = () => {
  handleLogout();
};
async function handleLogout() {
  const res = await fetch(`${ip}/api/admin_logout`, {
    method: 'POST',
    credentials: 'include'
  });
  const data = await res.json();
  if (res.ok) {
    alert("登出成功");
    window.location.href = "admin_login"; // ✅ 登出後跳轉到登入頁面
  } else {
    alert("登出失敗，請稍後再試");
  }
}
// ✅ 檢查登入狀態（進入頁面時）
window.onload = async () => {
  const res = await fetch(`${ip}/api/admin_login_status`, {
    method: 'GET',
    credentials: 'include'
  });
  const data = await res.json();
  if (data.status === 'success') {
    loadFaces();
    loadSchedules();
  } else {
    alert("尚未登入，請先登入管理者");
    window.location.href = "admin_login"; // ✅ 如果未登入，跳轉到登入頁面
  }
};
</script>
</body>
</html>