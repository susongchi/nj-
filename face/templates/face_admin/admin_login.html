<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>後台登入</title>
    <style>
        :root{
        --brand:#E5484D;         
        --brand-ink:#C53B3F;
        --bg:#F3F4F6;
        --card:#FFFFFF;
        --ink:#111827;
        --muted:#6B7280;
        --line:#E5E7EB;
        --ring:rgba(229,72,77,.35);
        --error:#DC2626;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
        margin:0; background:var(--bg);
        display:grid; place-items:center; padding:24px;
        font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
        color:var(--ink);
        }

        section{
        width:100%; max-width:420px;
        background:var(--card);
        border:1px solid rgba(0,0,0,.04);
        border-radius:16px;
        box-shadow:0 10px 30px rgba(0,0,0,.06);
        padding:32px;
        }

        .header{display:flex; align-items:center; gap:12px; justify-content: center;}
        .header img{width:36px; height:36px}
        .header .title{margin:0; font-size:22px; font-weight:700; letter-spacing:.3px; text-align: center;}
        .sub{color:var(--muted); font-size:14px; margin-bottom:18px; text-align:center}

        /* 欄位 */
        .form-group{margin-bottom:16px}
        .label{display:block; font-size:13px; color:#374151; margin-bottom:6px}
        .input-wrap{position:relative}
        .input{
        width:100%; height:44px; padding:0 14px;
        border:1px solid var(--line); border-radius:12px; background:#fff;
        outline:0; font-size:15px;
        }
        .input::placeholder{color:#9CA3AF}
        .input:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}

        /* 密碼眼睛 */
        .toggle-eye{
        position:absolute; right:8px; top:50%; transform:translateY(-50%);
        border:0; background:transparent; cursor:pointer; padding:6px; border-radius:8px;
        }
        .toggle-eye:focus{box-shadow:0 0 0 4px var(--ring)}
        .toggle-eye svg{width:20px; height:20px; stroke:#6B7280}
        .toggle-eye .icon-closed{ display:none; }
        .toggle-eye.showing .icon-open{ display:none; }
        .toggle-eye.showing .icon-closed{ display:inline; }

        /* 連結區 */
        .links{
        display:flex; align-items:center; justify-content:space-between;
        margin:6px 0 18px; font-size:14px;
        }
        a{color:var(--muted); text-decoration:none; transition:.2s}
        a:hover{color:var(--ink); text-decoration:underline}

        /* 按鈕 */
        .btn{
        width:100%; height:46px; border:0; border-radius:12px; cursor:pointer;
        font-size:15px; font-weight:700; letter-spacing:.3px;
        }
        .btn-primary{
        background:var(--brand); color:#fff;
        box-shadow:0 6px 16px rgba(229,72,77,.25)
        }
        .btn-primary:hover{background:var(--brand-ink)}
        .btn:disabled{opacity:.6; cursor:not-allowed}

        /* 輔助訊息 */
        .helper{margin-top:14px; font-size:14px; text-align:center; color:var(--muted)}
        .helper a{color:var(--ink)}
        .error{margin-top:8px; color:var(--error); font-size:13px; display:none}
        .hint{margin-top:8px; color:#b45309; font-size:13px; display:none}
    </style>
</head>

<body>
<section>
    <div class="header">
    <img src="https://i.ibb.co/PZVYTR1N/logo-12-1.png" alt="logo" />
    <h1 class="title">後台登入</h1>
    </div>
    <div class="sub">使用管理員帳號登入系統</div>

    <div class="form-group">
        <label class="label" for="adminUser">帳號</label>
        <div class="input-wrap">
        <input class="input" id="adminUser" type="text" placeholder="輸入帳號" required autofocus />
        </div>
    </div>

    <div class="form-group">
        <label class="label" for="adminPass">密碼</label>
        <div class="input-wrap">
        <input class="input" id="adminPass" type="password" placeholder="輸入密碼" required />
        <button id="togglePwd" class="toggle-eye" aria-label="顯示密碼" aria-pressed="false">
            <!-- open eye -->
            <svg class="icon icon-open" viewBox="0 0 24 24" fill="none" stroke-width="2" storke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            <!-- closed eye -->
            <svg class="icon icon-closed" viewBox="0 0 24 24" fill="none" stroke-width="2">
                <path d="M3 3l18 18"/>
                <path d="M2 12s4-7 10-7c2.4 0 4.6.8 6.5 2.1"/>
                <path d="M22 12s-4 7-10 7c-2.4 0-4.6-.8-6.5-2.1"/>
                <path d="M14.1 14.1A3 3 0 0 1 9.9 9.9"/>
            </svg>
        </button>
        </div>
        <div id="capsHint" class="hint">Caps Lock 可能開啟</div>
    </div>

    <div class="links">
        <a href="/admin_register">註冊帳號</a>
        <a href="/admin_forget_password">忘記密碼</a>
    </div>

    <button id="adminLoginBtn" class="btn btn-primary" disabled>登入</button>
    <div id="adminLoginMsg" class="error">帳號或密碼不正確</div>
</section>

    <script>
        let ip = "https://322b23d6594f.ngrok-free.app";

        const toggle = document.getElementById("togglePwd");
        const usernameEl = document.getElementById("adminUser");
        const passwordEl = document.getElementById("adminPass");
        const loginBtn   = document.getElementById("adminLoginBtn");
        const msgDiv     = document.getElementById("adminLoginMsg");
        const inputList  = [usernameEl, passwordEl];

        let inFlight = false; // 防止連點

        // 讓按鈕在兩個欄位都有值時才啟用（你的 Enter 送出保留）
        function syncBtn(){
            loginBtn.disabled = !(usernameEl.value.trim() && passwordEl.value.trim());
        }
        inputList.forEach(el => el.addEventListener('input', syncBtn));
        syncBtn(); // 初始化

        const handleLogin = async () => {
            if (inFlight) return;

            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            if (!username || !password) {
            msgDiv.style.display = 'block';
            msgDiv.style.color = "red";
            msgDiv.textContent = "請輸入帳號與密碼";
            return;
            }

            inFlight = true;
            const oldText = loginBtn.textContent;
            loginBtn.disabled = true;
            loginBtn.textContent = "登入中…";
            msgDiv.style.display = 'none';
            msgDiv.textContent = "";

            try {
            const res = await fetch(`${ip}/api/admin_login`, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });

            const data = await res.json().catch(() => ({ status: "fail", message: "無法解析伺服器回應" }));

            if (data.status === "success") {
                msgDiv.style.display = 'block';
                msgDiv.style.color = "green";
                msgDiv.textContent = "登入成功";
                window.location.href = "face_manage"; // 保留你的導向
            } else {
                msgDiv.style.display = 'block';
                msgDiv.style.color = "red";
                msgDiv.textContent = data.message || "登入失敗";
            }
            } catch (err) {
            msgDiv.style.display = 'block';
            msgDiv.style.color = "red";
            msgDiv.textContent = "網路連線失敗，請稍後再試";
            } finally {
            inFlight = false;
            loginBtn.textContent = oldText;
            syncBtn(); // 根據欄位內容還原按鈕狀態
            }
        };

        // Enter 送出（保留你的邏輯）
        inputList.forEach(element => {
            element.addEventListener("keydown", function (e) {
            if (e.key === "Enter") handleLogin();
            });
        });

        // 眼睛切換：綁定 #togglePwd（你原本的 #eye 已不存在）
        toggle.addEventListener("click", function () {
            const show = passwordEl.type === "password";
            passwordEl.type = show ? "text" : "password";
            toggle.classList.toggle("showing", show);
            toggle.setAttribute("aria-pressed", show);
            toggle.setAttribute("aria-label", show ? "隱藏密碼" : "顯示密碼");
        });

        // 點擊登入
        loginBtn.onclick = () => handleLogin();

        // （可選）Caps Lock 提示：你頁面有 #capsHint，但沒綁邏輯
        const capsHint = document.getElementById("capsHint");
        passwordEl.addEventListener("keyup", (e)=>{
            if (e.getModifierState && e.getModifierState("CapsLock")) {
            capsHint.style.display = "block";
            } else {
            capsHint.style.display = "none";
            }
        }); 
    </script>
</body>
</html>