<!DOCTYPE html>
<html>
<head>
  <title>管理後台</title>
  <style>
    :root{
    --brand:#3b82f6;      
    --danger:#ef4444;   
    --success:#16a34a;   
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --bg:#ffffff;
    --panel:#f8fafc;  
    }

    *{box-sizing:border-box}
    html,body{margin:0}
    body{
      font:16px/1.6 "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:var(--text); background:var(--panel);
    }

    /* 版心與頂部 */
    .container{max-width:980px; margin:28px auto; padding:0 18px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;
    }
    .topbar h2{margin:0; font-size:22px}

    /* 區塊 / 標題 */
    .panel{
      background:var(--bg); border:1px solid var(--border);
      border-radius:14px; padding:18px; margin-bottom:16px;
      box-shadow:0 6px 20px -12px rgba(0,0,0,.12);
    }
    .section-title{margin:0 0 10px; font-size:18px}

    /* 標籤 + 欄位 */
    .label{font-size:14px; color:var(--muted)}
    .form-grid{
      display:grid; grid-template-columns:1fr; gap:10px;
    }
    .form-grid.two-col{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    .field{margin-top:10px}

    input[type="text"], input[type="date"], input[type="time"], input[type="file"]{
      height:44px; padding:0 12px; border:1px solid var(--border); border-radius:10px;
      background:#fff; outline:none; transition:border-color .2s, box-shadow .2s;
    }
    input[type="file"]{ padding:10px 12px; height:auto }
    input:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 3px color-mix(in srgb, var(--brand) 25%, transparent);
    }

    /* 參與者勾選區：自適應多欄 */
    .checks-grid{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
      gap:8px; margin-top:6px;
    }
    .checks-grid label{display:flex; align-items:center; gap:8px}

    /* 按鈕 */
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; height:44px; padding:0 16px; border-radius:10px;
      font-weight:600; border:1px solid transparent; cursor:pointer;
      transition:transform .12s, box-shadow .2s, background-color .2s, color .2s, border-color .2s;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0) scale(.98)}
    .btn:focus-visible{outline:3px solid color-mix(in srgb, var(--brand) 35%, transparent); outline-offset:2px}

    .btn-primary{background:var(--brand); color:#fff}
    .btn-primary:hover{box-shadow:0 10px 24px -10px color-mix(in srgb, var(--brand) 60%, transparent)}

    .btn-ghost{background:#fff; color:var(--text); border:1px solid var(--border)}
    .btn-ghost:hover{background:#f7f7f9}
    .btn-danger{
    background:#fff;
    color:var(--danger);
    border:1px solid var(--danger);
    }
    .btn-danger:hover{
    background:color-mix(in srgb, var(--danger) 10%, #fff);
    }
    .btn-sm{ height:30px; padding:0 10px; }

    /* 動作列 */
    .actions{margin-top:12px}

    /* 訊息條（你的 JS 把 display 打開，並視情況加 ok/error） */
    .alert{
      margin-top:10px; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#fff; color:var(--text);
    }
    .alert.ok{
      border-color:color-mix(in srgb, var(--success) 30%, var(--border));
      background:color-mix(in srgb, var(--success) 8%, #fff);
      color:color-mix(in srgb, var(--success) 60%, #0a0a0a);
    }
    .alert.error{
      border-color:color-mix(in srgb, var(--danger) 30%, var(--border));
      background:color-mix(in srgb, var(--danger) 8%, #fff);
      color:color-mix(in srgb, var(--danger) 60%, #0a0a0a);
    }

    /* 已註冊人臉：卡片網格（你的 JS 填進 #faceList） */
    .faces-grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:16px;
    }
    .face-card{
      border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff; text-align:center;
      display: flex; flex-direction: column; align-items: center; gap:8px;
    }
    .face-card img{ 
      width:100%; height:120px; object-fit:cover; border-radius:8px; aspect-ratio: 3/4; display: block;
    }
    .face-card .name{
      font-weight: 600; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* 會議卡片清單（你的 JS 填進 #schedules） */
    .cards{ display:flex; flex-direction:column; gap:10px; }
    .card{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px; border:1px solid var(--border); border-radius:12px; background:#fff;
    }
    .card .meta{display:flex; flex-direction:column}
    .card .title{font-weight:700}
    .card .sub{color:var(--muted); font-size:14px; margin-top:2px}
    .card .actions{margin:0}

    /* 讓小螢幕友善 */
    @media (max-width:720px){
      .form-grid.two-col{ grid-template-columns:1fr; }
      .card{flex-direction:column; align-items:flex-start; gap:10px}
    }

    #logoutBtn{
    position: fixed;    
    top: 12px;
    right: 16px;
    z-index: 2000;

    width: auto !important;
    display: inline-flex; 
    align-items: center; 
    justify-content: center;

    min-height: 40px;
    padding: 8px 14px;
    border-radius: 10px;
    cursor: pointer;
    }
  </style>
 <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div id="cameraModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; text-align:center;">
    <h3>請對準鏡頭並點擊下方按鈕</h3>
    <video id="cameraVideo" autoplay width="320" height="240" style="border:1px solid #ccc;"></video><br>
    <button id="takePhotoBtn" style="margin-top:10px;">拍照註冊</button>
    <button onclick="closeCameraModal()" style="margin-top:10px;">取消</button>
  </div>
</div>
<div class="container">
  <header class="topbar">
    <h2>人臉管理與會議排程</h2>
    <button id="logoutBtn" class="btn btn-ghost">登出</button>
  </header>

  <section class="panel">
    <h3 class="section-title">新增使用者</h3>

    <div class="form-grid">
      <label for="newName" class="label">姓名</label>
      <input type="text" id="newName" placeholder="請輸入姓名" />

      <label for="newPhoto" class="label">上傳人臉照片</label>
      <input type="file" id="newPhoto" accept="image/*" />
    </div>

    <div class="actions">
      <button id="registerBtn" class="btn btn-primary">註冊使用者</button>
    </div>

    <div id="registerMsg" class="alert" style="display:none;"></div>
  </section>

  <section class="panel">
    <h3 class="section-title">已註冊人臉</h3>
    <div id="faceList" class="faces-grid">載入中...</div>
  </section>

  <section class="panel">
    <h3 class="section-title">設定排程</h3>

    <div class="form-grid two-col">
      <label for="meetingName" class="label">會議名稱</label>
      <input type="text" id="meetingName" placeholder="請輸入會議名稱" />

      <label for="date" class="label">會議日期</label>
      <input type="date" id="date" />

      <label for="startTime" class="label">開始時間</label>
      <input type="time" id="startTime" />

      <label for="endTime" class="label">結束時間</label>
      <input type="time" id="endTime" />
    </div>

    <div class="field">
      <div class="label">選擇參與者</div>
      <div id="participantsCheckboxes" class="checks-grid">載入中...</div>
    </div>

    <div class="actions">
      <button id="saveScheduleBtn" class="btn btn-primary">儲存排程</button>
    </div>

    <div id="message" class="alert" style="display:none;"></div>
  </section>

  <section id="scheduleList" class="panel">
    <h3 class="section-title">現有會議排程</h3>
    <div id="schedules" class="cards">載入中...</div>
  </section>
</div>

<script>
let ip = "https://322b23d6594f.ngrok-free.app";
let videoStream = null;

async function loadFaces() {
  const res = await fetch(`${ip}/api/faces`, { credentials: 'include' });
  const data = await res.json();

  const container = document.getElementById('faceList');
  const checkboxContainer = document.getElementById('participantsCheckboxes');
  container.innerHTML = '';
  checkboxContainer.innerHTML = '';

  if (data.status !== 'success' || !data.faces || data.faces.length === 0) {
    container.innerHTML = '<div style="color:var(--muted)">尚無資料</div>';
    return;
  }

  container.innerHTML = data.faces.map(f => `
    <figure class="face-card">
      <img src="${f.url}" alt="${f.name}">
      <figcaption class="name">${f.name}</figcaption>
      <button class="btn btn-danger btn-sm" data-delete-face="${f.id}">刪除</button>
    </figure>
  `).join('');

  checkboxContainer.innerHTML = data.faces.map(f => `
    <label><input type="checkbox" name="participants" value="${f.name}"> ${f.name}</label>
  `).join('');
}

async function loadSchedules() {
  const res = await fetch(`${ip}/api/get_schedules`, { credentials: 'include' });
  const data = await res.json();

  const container = document.getElementById('schedules');
  container.innerHTML = '';

  if (data.status !== 'success' || !data.schedule || Object.keys(data.schedule).length === 0) {
    container.innerHTML = '<div style="color:var(--muted)">目前沒有排程</div>';
    window.currentSchedules = {};
    return;
  }

  for (const [fullKey, users] of Object.entries(data.schedule)) {
    const [meetingName, timeSlot] = fullKey.split('｜'); 
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="meta">
        <div class="title">${meetingName || '未命名會議'}</div>
        <div class="sub">${timeSlot || ''} · ${users.join('、')}</div>
      </div>
      <div class="actions">
        <button class="btn btn-danger btn-sm" data-delete-schedule="${fullKey}">刪除排程</button>
      </div>
    `;
    container.appendChild(card);
  }

  window.currentSchedules = data.schedule;
}

document.getElementById('faceList').addEventListener('click', (e) => {
  const btn = e.target.closest('[data-delete-face]');
  if (!btn) return;
  deleteUser(btn.getAttribute('data-delete-face'));
});

document.getElementById('schedules').addEventListener('click', (e) => {
  const btn = e.target.closest('[data-delete-schedule]');
  if (!btn) return;
  deleteSchedule(btn.getAttribute('data-delete-schedule'));
});

document.getElementById('saveScheduleBtn').onclick = async () => {
  const meetingName = document.getElementById('meetingName').value.trim();
  const date  = document.getElementById('date').value;
  const start = document.getElementById('startTime').value;
  const end   = document.getElementById('endTime').value;

  const names = Array.from(document.querySelectorAll('input[name="participants"]:checked'))
    .map(cb => cb.value);

  if (!meetingName || !date || !start || !end || names.length === 0) {
    alert('請完整填寫會議名稱、日期、時間與參與者'); return;
  }
  if (start >= end) { alert('結束時間不能早於或等於開始時間'); return; }

  const newSlotStr = `${date} ${start}-${end}`;
  const newSlot = parseTimeSlot(newSlotStr);
  const cur = window.currentSchedules || {};
  const conflicts = [];

  for (const [fullKey, existedUsers] of Object.entries(cur)) {
    const [existName, existSlotStr] = fullKey.split('｜');
    const existSlot = parseTimeSlot(existSlotStr);
    const sameDay    = newSlot.dateStr === existSlot.dateStr;
    const timeClash  = rangesOverlap(newSlot.start, newSlot.end, existSlot.start, existSlot.end);
    const memberSame = hasMemberOverlap(names, existedUsers);
    if (sameDay && timeClash && memberSame) {
      conflicts.push(`• ${existName}｜${existSlotStr}（衝突成員：${names.filter(n => existedUsers.includes(n)).join('、')}）`);
    }
  }
  if (conflicts.length) { alert(`發現時間衝突：\n${conflicts.join('\n')}`); return; }

  const payload = { time_slot: newSlotStr, meeting_name: meetingName, names };
  const res = await fetch(`${ip}/api/allowed_users_by_schedule`, {
    method:'POST', credentials:'include',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  const msgDiv = document.getElementById('message');
  if (data.status === 'success') {
    msgDiv.style.color = 'green';
    msgDiv.textContent = data.message;
    loadSchedules();
  } else {
    msgDiv.style.color = 'red';
    msgDiv.textContent = data.message;
  }
};


async function deleteUser(userId) {
  if (!confirm('確定要刪除這個使用者嗎？這會清除照片與資料。')) return;

  const res = await fetch(`${ip}/api/delete_user/${userId}`, {
    method: 'DELETE',
    credentials: 'include'
  });

  const data = await res.json();
  alert(data.message);
  loadFaces();
  loadSchedules();
}

async function deleteSchedule(fullTimeKey) {
  if (!confirm(`你確定要刪除排程：${fullTimeKey} 嗎？`)) return;

  const [meetingName, timeSlot] = fullTimeKey.split("｜"); 

  const res = await fetch(`${ip}/api/delete_schedule`, {
    method: "POST",
    credentials: 'include',
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      meeting_name: meetingName.trim(),
      time_slot: timeSlot.trim()
    })
  });

  const data = await res.json();
  alert(data.message);
  loadSchedules();
}

document.getElementById('registerBtn').onclick = async () => {
  const name = document.getElementById('newName').value.trim();
  const photoInput = document.getElementById('newPhoto');
  const photo = photoInput.files[0];
  const msgDiv = document.getElementById('registerMsg');

  if (!name) {
    alert('請輸入姓名');
    return;
  }

  const checkRes = await fetch(`${ip}/api/check_name_exists?name=${encodeURIComponent(name)}`, {
    credentials: 'include'
  });
  const checkData = await checkRes.json();

  if (checkData.exists) {
    alert('此姓名已註冊，請使用不同名稱');
    return;
  }

  if (photo) {
  // 基本檔案檢查
  const err = basicFileCheck(photo);
  if (err) { alert(err); return; }

  // 人臉數檢查（必須 = 1）
  const faceCount = await countFacesFromFile(photo);
  if (faceCount === 0) { alert('沒有偵測到人臉，請更換照片'); return; }
  if (faceCount > 1) { alert('偵測到多於 1 張人臉，請上傳只有本人臉的照片'); return; }

  // ✅ 通過才送出
  const formData = new FormData();
  formData.append("name", name);
  formData.append("photo", photo);

  const res = await fetch(`${ip}/api/register`, {
    method: 'POST',
    credentials: 'include',
    body: formData
  });

    const data = await res.json();
    if (data.status === 'success') {
      msgDiv.style.color = 'green';
      msgDiv.textContent = data.message;
      document.getElementById('newName').value = '';
      photoInput.value = '';
      loadFaces();
    } else {
      msgDiv.style.color = 'red';
      msgDiv.textContent = data.message;
    }
  } else {
    // ❌ 沒有照片 → 自動開啟相機拍照
    try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const video = document.getElementById('cameraVideo');
    video.srcObject = stream;
    videoStream = stream; // 儲存 stream，等下拍照後可以關掉
    document.getElementById('cameraModal').style.display = 'flex';
  } catch (err) {
    alert('開啟攝影機失敗，請允許瀏覽器使用相機');
    console.error(err);
  }
}
};

function parseTimeSlot(slotStr) {
  // 例: "2025-08-19 07:24-14:28"
  const [dateStr, range] = slotStr.trim().split(' ');
  const [startStr, endStr] = range.split('-');
  const start = new Date(`${dateStr}T${startStr}:00`);
  const end   = new Date(`${dateStr}T${endStr}:00`);
  return { dateStr, start, end };
}
function rangesOverlap(aStart, aEnd, bStart, bEnd) {
  // 有交集即視為衝突；若你希望「剛好接在邊界」不算衝突，這個條件已符合
  return aStart < bEnd && bStart < aEnd;
}
function hasMemberOverlap(a, b) {
  return a.some(x => b.includes(x));
}


document.getElementById('takePhotoBtn').onclick = async () => {
  const name = document.getElementById('newName').value.trim();
  const msgDiv = document.getElementById('registerMsg');
  const video = document.getElementById('cameraVideo');
  if (!name) { alert("請輸入姓名後再拍照"); return; }

  const canvas = document.createElement('canvas');
  canvas.width = 320; canvas.height = 240;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // 先用瀏覽器 FaceDetector 偵測（若存在）
  if ('FaceDetector' in window) {
    const detector = new FaceDetector({ fastMode: true, maxDetectedFaces: 5 });
    const bmp = await createImageBitmap(canvas);
    const faces = await detector.detect(bmp);
    bmp.close?.();
    if (faces.length === 0) { alert('沒有偵測到人臉，請重新對準拍攝'); return; }
    if (faces.length > 1) { alert('畫面中有多於 1 張人臉，請確保只有本人再拍攝'); return; }
  } else {
    // 沒有 FaceDetector 才產 blob 並送後端數臉
    const tmpBlob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.9));
    const count = await countFacesOnServer(tmpBlob);
    if (count === 0) { alert('沒有偵測到人臉，請重新對準拍攝'); return; }
    if (count > 1) { alert('畫面中有多於 1 張人臉，請確保只有本人再拍攝'); return; }
  }

  // ✅ 通過檢查後，再產 blob 用於上傳（或重用剛才的 tmpBlob 也行）
  canvas.toBlob(async blob => {
    const formData = new FormData();
    formData.append("name", name);
    formData.append("photo", blob, `${name}.jpg`);

    const res = await fetch(`${ip}/api/register`, {
      method: 'POST', credentials: 'include', body: formData
    });
    const data = await res.json();
    if (data.status === 'success') {
      msgDiv.style.color = 'green';
      msgDiv.textContent = data.message;
      document.getElementById('newName').value = '';
      loadFaces();
    } else {
      msgDiv.style.color = 'red';
      msgDiv.textContent = data.message;
    }
    closeCameraModal();
  }, 'image/jpeg', 0.9);
};


function closeCameraModal() {
  document.getElementById('cameraModal').style.display = 'none';
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
}

// 允許的圖片型態與大小
const ALLOWED_TYPES = ['image/jpeg','image/png','image/webp'];
const MAX_FILE_MB = 5;

// 基本檔案檢查
function basicFileCheck(file) {
  if (!file) return '沒有選擇檔案';
  if (!ALLOWED_TYPES.includes(file.type)) return '僅允許 JPG / PNG / WebP 圖片';
  if (file.size > MAX_FILE_MB * 1024 * 1024) return `檔案過大，請小於 ${MAX_FILE_MB}MB`;
  return null;
}

// 後端備援檢測（需要後端提供 /api/face_count，回 {count:number}）
async function countFacesOnServer(fileOrBlob) {
  const fd = new FormData();
  fd.append('image', fileOrBlob, 'frame.jpg');
  const res = await fetch(`${ip}/api/face_count`, { method: 'POST', credentials: 'include', body: fd });
  const data = await res.json().catch(() => ({}));
  return typeof data.count === 'number' ? data.count : 0;
}

async function countFacesFromFile(file) {
  if ('FaceDetector' in window) {
    try {
      const detector = new FaceDetector({ fastMode: true, maxDetectedFaces: 5 });
      const bmp = await createImageBitmap(file, { imageOrientation: 'from-image' }); // ← 重點
      const faces = await detector.detect(bmp);
      bmp.close?.();
      if (faces.length > 0) return faces.length; // 有抓到就回傳
      // 0 臉 → fallback
    } catch (e) {
      console.warn('FaceDetector(file) error → fallback server:', e);
    }
  }
  return await countFacesOnServer(file);
}

// 從 Canvas 偵測臉數：先用 FaceDetector，若 0 臉/錯誤 → 打後端
async function countFacesFromCanvas(canvas) {
  if ('FaceDetector' in window) {
    try {
      const detector = new FaceDetector({ fastMode: true, maxDetectedFaces: 5 });
      const bmp = await createImageBitmap(canvas);
      const faces = await detector.detect(bmp);
      bmp.close?.();
      if (faces.length > 0) return faces.length;
      // 0 臉 → fallback
    } catch (e) {
      console.warn('FaceDetector(canvas) error → fallback server:', e);
    }
  }
  const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.9));
  return await countFacesOnServer(blob);
}

document.getElementById('logoutBtn').onclick = () => {
  handleLogout();
};
async function handleLogout() {
  const res = await fetch(`${ip}/api/admin_logout`, {
    method: 'POST',
    credentials: 'include'
  });
  const data = await res.json();
  if (res.ok) {
    alert("登出成功");
    window.location.href = "admin_login"; // ✅ 登出後跳轉到登入頁面
  } else {
    alert("登出失敗，請稍後再試");
  }
}
// ✅ 檢查登入狀態（進入頁面時）
window.onload = async () => {
  const res = await fetch(`${ip}/api/admin_login_status`, {
    method: 'GET',
    credentials: 'include'
  });
  const data = await res.json();
  if (data.status === 'success') {
    loadFaces();
    loadSchedules();
  } else {
    alert("尚未登入，請先登入管理者");
    window.location.href = "admin_login"; // ✅ 如果未登入，跳轉到登入頁面
  }
};
</script>
</body>
</html>